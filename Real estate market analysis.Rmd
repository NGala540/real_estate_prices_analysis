---
title: "Real estate market analysis"
author: "Nazar Ostrowski, Norbert Gała, Stanisław Kochnowski"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: true
    theme: sandstone
    css: style.css
    fig_width: 10
    fig_height: 10
    fig_caption: true
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Real estate market analysis

## Introduction

The real estate market plays a crucial role in economic growth, urban development, and investment strategies. Understanding its structure, pricing trends, and key influencing factors is essential for stakeholders, including buyers, investors, and policymakers. This project provides an in-depth analysis of the real estate market using statistical methods and data visualization techniques to extract meaningful insights from the available data.

The following milestones were outlined during design process:

1.  **Explatory Analysis**: Understanding the format, types, and sources of data.

2.  **Data Cleansing and Wrangling**: Ensuring data accuracy, handling missing values, and standardizing formats.

3.  **Outliers**: Identifying and analyzing unusual price points that may affect overall trends.

4.  **Visualizations**: Graphical representations to facilitate pattern recognition and trend analysis.

5.  **Descriptive Analysis**: Exploring key metrics like mean, median, variance, and skewness, recovered aggregated statistical insights that describe the market dynamics.

6.  **Price Distribution Shape**: Analyzing the distribution of prices through density plots and statistical summaries.

7.  **Statistical Tests**: Assessing the statistical significance of median price differences across cities and investigating the impact of amenities on price variations.

### Objectives

-   Provide a clear understanding of real estate price structures.

-   Identify significant price differentiators and market trends.

-   Utilize statistical techniques to validate insights.

-   Present findings through comprehensive visual and tabular representations.

```{r message=FALSE, warning=FALSE}
### Downloading necessary libraries
# Installing the libraries
if (!require(tidyverse)) install.packages("tidyverse") 
if (!require(dplyr)) install.packages("dplyr")
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(naniar)) install.packages("naniar")
if (!require(mice)) install.packages("mice")
if (!require(modelsummary)) install.packages("modelsummary")
if (!require(reshape2)) install.packages("reshape2")
if (!require(editrules)) install.packages("editrules")
if (!require(dlookr)) install.packages("dlookr")
if (!require(editrules)) install.packages("editrules")
if (!require(VIM)) install.packages("VIM")
if (!require(deducorrect)) install.packages("deducorrect")
if (!require(ISLR)) install.packages("ISLR")
if (!require(outliers)) install.packages("outliers")
if (!require(ggstatsplot)) install.packages("ggstatsplot")
if (!require(scales)) install.packages("scales")
if (!require(corrplot)) install.packages("corrplot")
if (!require(gridExtra)) install.packages("grid.extra")
if (!require(kableExtra)) install.packages("kable.extra")
if (!require(plyr)) install.packages("plyr")
if (!require(summarytools)) install.packages("summarytools")
if (!require(classInt)) install.packages("classInt")
if (!require(psych)) install.packages("psych")
if (!require(here)) install.packages("here")
if (!require(tidyr)) install.packages("tidyr")
if (!require(plotly)) install.packages("plotly")
if (!require(egg)) install.packages("egg")

# Attaching the libraries
library(tidyverse)
library(dplyr)
library(ggplot2)
library(naniar)
library(mice)
library(modelsummary)
library(reshape2)
library(editrules)
library(dlookr)
library(editrules)
library(VIM)
library(deducorrect)
library(ISLR)
library(outliers)
library(ggstatsplot)
library(RColorBrewer)
library(viridis)
library(rlang)
library(scales)
library(corrplot)
library(gridExtra)
library(kableExtra)
library(plyr)
library(summarytools)
library(classInt)
library(psych)
library(here)
library(tidyr)
library(plotly)
library(egg)
```

### Data structure

The dataset contains apartment sales and rental offers from 15 largest cities in Poland (Warsaw, Lodz, Krakow, Wroclaw, Poznan, Gdansk, Szczecin, Bydgoszcz, Lublin, Katowice, Bialystok, Czestochowa). The data comes from local websites with apartments for sale. In order to fully capture the neighborhood of each apartment, each listing has been augmented with Open Street Map data with distances to points of interest (POIs). The data is collected monthly and covers the period from August 2523 to June 2524.

#### Files

apartments_pl_YYY_MM.csv - monthly snapshot of sales listings

apartments_rent_pl_YYYY_MM.csv - monthly snapshot of rental offers

#### Data fields

-   city - name of the city where the property is located
-   type - type of building
-   squareMeters - size of the apartment in square meters
-   rooms - number of rooms in the apartment
-   floor / floorCount - floor on which the apartment is located and the total number of floors in the building
-   buildYear - the year in which the building was built
-   latitude, longitude - geographical coordinates of the property
-   centerDistance - distance from the city center in km
-   poiCount - number of places of interest within a radius of 500m from the apartment (schools, clinics, post office, kindergartens, restaurants, universities, pharmacies)
-   Distance - distance to the nearest point of interest (schools, clinics, post office, etc.)

Important data manipulations conducted in this step are adding months of when the data come from to the dataset, and binding files. In the raw state of data, this date is only included in the name of the file, and also we have separate files for each month.

```{r}
# Loading data
load_data <- function(name_struct) {
  files_names = 
    # Listing files in the proper location and with given pattern
    list.files(
    path = file.path("./analiza_danych_projekt_zespolowy/Nieruchomosci w Polsce"),
    pattern = name_struct, 
    full.names = TRUE)
  myfiles = lapply(files_names, read.csv)
  
  # adding column "month", labeling data from which month it was scrapped
  for (i in seq_along(myfiles)) {myfiles[[i]]$month = to_date(files_names[i])}
  
  # bind together dataframe
  return(do.call(rbind, myfiles))
}

# adding new column to each DF with month
to_date <- function(primary_date) {
  date_part <- sub(".*(\\d{4}_\\d{2}).*", "\\1", primary_date)
  complete_date <- paste0(date_part, "_01")
  
  parsed_date <- 
    as.Date(complete_date, format = "%Y_%m_%d")
  
  return(parsed_date)
}

data_buy = load_data("^apartments_pl_[0-9]+_[0-9]+\\.csv$")
data_rent = load_data("^apartments_rent_pl_[0-9]+_[0-9]+\\.csv$")
```

## Data Cleansing and Wrangling

Data cleansing and wrangling are essential steps in the data analysis process, ensuring that raw data is transformed into a structured, accurate, and usable format. Data cleansing involves among others handling missing values, outliers and identifying and correcting errors. Data wrangling focuses on reshaping, merging, and transforming datasets to make them suitable for analysis.

The goal of these processes is to enhance data integrity, eliminate inconsistencies, and prepare the dataset for meaningful insights.

#### Removing unnecessary data

Row IDs are unique and therefore provide no differentiation or analytical value. Additionally, due to the nature of the data, duplicate values are possible. For example, if a property was listed for sale in January but sold in March, it would appear three times—once for each month it was listed.

```{r include=FALSE}
n_occur_buy <- data.frame(table(data_buy$id))
n_occur_buy[n_occur_buy$Freq > 1,]

n_occur_rent <- data.frame(table(data_rent$id))
n_occur_rent[n_occur_rent$Freq > 1,]
```

```{r pressure, echo=FALSE}
data_buy <- data_buy[!duplicated(data_buy$id),]
data_rent <- data_rent[!duplicated(data_rent$id),]

data_buy <- data_buy %>% 
  select(-id)

data_rent <- data_rent %>% 
  select(-id)
```

#### Data summary

```{r eval=FALSE, include=FALSE}
data_buy
data_rent
```

```{r eval=FALSE, include=FALSE}
datasummary_skim(data_buy)
datasummary_skim(data_rent)
```

A brief exploration of the dataset reveals that both the rent and buy datasets share the same 28 features, which include both categorical and continuous variables. The buy dataset contains 92 967 unique records, while the rent dataset has 37 941 unique records. An interesting observation is that the data includes not only missing values (NAs) but also different type of blank entries, which will be addressed in the next section.

#### Checking NAs

```{r include=FALSE}
# Checking the nature of "other" blanks and replacing them with NA
data_buy[5,"buildingMaterial"]
data_buy[data_buy==""] <- NA
data_rent[data_rent==""] <- NA
```

```{r}
knitr::kable(data.frame(miss_var_summary(data_buy)))
knitr::kable(data.frame(miss_var_summary(data_rent)))
```

Both data sets have some serious problems with missing data, especially in condition and building material.

<h4 style="text-align: center;font-weight: bold;">

Data set 'buy'

<h4>

```{r}
# Upset plot of missing data and number of missings by a city - buy dataset
NA_vector_buy <- c("floor", "buildYear", "collegeDistance", "floorCount", 
               "clinicDistance", "restaurantDistance", "pharmacyDistance", 
               "postOfficeDistance", "kindergartenDistance", "schoolDistance",
               "condition", "buildingMaterial", "type", "hasElevator")

gg_miss_upset(data_buy, nsets=14, mb.ratio = c(0.5, 0.5), text.scale = c(2.5,2.5,2.5,2.5,1.9,1.5),
              set_size.numbers_size=TRUE, set_size.show = TRUE)
```

```{r, fig.width=10, fig.height=8}
gg_miss_fct(data_buy[,c(NA_vector_buy, "city")], fct = city) +
  theme(text = element_text(size = 25)) 
```

An analysis of missing values in the 'buy' dataset using an upset plot reveals some connections between condition, building material, and type. However, given the scale of missing values in these features, their mutual occurrence does not appear to be significant. On the other hand, in Gdańsk and Gdynia, the 'condition' attribute is missing more frequently than in other cities, while in Częstochowa, the 'build year' is notably absent more often.

<h4 style="text-align: center;font-weight: bold;">

Data set 'rent'

<h4>

```{r, fig.width=10, fig.height=8}
# Upset plot of missing data and number of missings by a city - rent dataset
NA_vector_rent <- c("condition", "floor", "buildYear", "floorCount", "collegeDistance",
               "clinicDistance", "restaurantDistance", "pharmacyDistance", 
               "postOfficeDistance", "kindergartenDistance", "schoolDistance")

gg_miss_upset(data_rent, nsets=10, mb.ratio = c(0.5, 0.5), text.scale = c(2.5,2.5,2.5,2.5,1.9,1.5),
              set_size.numbers_size=TRUE, set_size.show = TRUE)
```

```{r, fig.width=10, fig.height=8}
gg_miss_fct(data_rent[,c(NA_vector_rent, "city")], fct = city) +
  theme(text = element_text(size = 25)) 
```

A similar pattern is observed in the 'rent' dataset. Once again, some connections between condition, building material, and type are visible, but they do not appear to be significant. In this case, missing condition data is noticeable not only in Gdańsk and Gdynia but also in Częstochowa, where the 'build year' attribute is also frequently missing.

In the next steps will be checked correlation between NAs and other variable, for this purpose we will conduct below steps:

-   code NAs to 1 (in case of NA) and 0

-   code binary, categorical variables

-   exclude non binar variables

```{r warning=FALSE, fig.width=10, fig.height=8}
# Coding NAs
NA_data_buy = data_buy
NA_data_rent = data_rent

for (i in 1:length(NA_vector_buy)) {
  col_name <- paste("NA",NA_vector_buy[i], sep="_")
  NA_data_buy[[col_name]] <- ifelse(is.na(NA_data_buy[[NA_vector_buy[i]]]), 1, 0)
}

for (i in 1:length(NA_vector_rent)) {
  col_name <- paste("NA",NA_vector_rent[i], sep="_")
  NA_data_rent[[col_name]] <- ifelse(is.na(NA_data_rent[[NA_vector_rent[i]]]), 1, 0)
}

# Coding categorical variables
NA_data_buy$condition <- 
  NA_data_buy$condition %>% 
  ordered(c("low", "premium")) %>% 
  as.numeric()-1

NA_data_rent$condition <- 
  NA_data_rent$condition %>% 
  ordered(c("low", "premium")) %>% 
  as.numeric()-1

yes_no_variables <- c("hasParkingSpace", "hasBalcony", "hasElevator", 
                      "hasSecurity", "hasStorageRoom")

for (i in 1:length(yes_no_variables)){
  NA_data_buy[[yes_no_variables[i]]] <- 
    NA_data_buy[[yes_no_variables[i]]] %>% 
    ordered(c("no", "yes")) %>% 
    as.numeric()-1
  
  NA_data_rent[[yes_no_variables[i]]] <- 
    NA_data_rent[[yes_no_variables[i]]] %>% 
    ordered(c("no", "yes")) %>% 
    as.numeric()-1
}

# vector of features to exclude
exclude_HM <- c("city", "type", "ownership", "buildingMaterial", "month", 
                "condition", "hasElevator")

# Heat maps

selected_features1 <- names(NA_data_buy)[startsWith(names(NA_data_buy), "NA_")]
selected_features2 <- names(NA_data_buy)[!startsWith(names(NA_data_buy), "NA_")]

NA_data_buy[,!names(NA_data_buy) %in% exclude_HM] %>%
  cor(use = "pairwise.complete.obs") %>%
  round(digits=2) %>%
  melt() %>%
  filter(Var1 %in% selected_features2 & Var2 %in% selected_features1) %>%
  ggplot(aes(x=Var1, y=Var2, fill=value))  +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Correlation matrix with NA - 'buy' dataset") +
  scale_fill_gradient2(low = "red", mid = "#FFDD94", high = "green", midpoint = 0)+
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  +
  theme(text = element_text(size = 25)) 

selected_features1 <- names(NA_data_rent)[startsWith(names(NA_data_rent), "NA_")]
selected_features2 <- names(NA_data_rent)[!startsWith(names(NA_data_rent), "NA_")]
  
NA_data_rent[, !names(NA_data_rent) %in% exclude_HM] %>%
  cor(use = "pairwise.complete.obs") %>%
  round(digits = 2) %>%
  melt() %>%
  filter(Var1 %in% selected_features2 & Var2 %in% selected_features1) %>%
  ggplot(aes(x = Var1, y = Var2, fill = value)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Correlation matrix with NA - 'rent' dataset") +
  scale_fill_gradient2(low = "red", mid = "#FFDD94", high = "green", midpoint = 0) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  theme(text = element_text(size = 25)) 
```

Correlation matrix doesn't show any strong dependencies between missing and other variables

### Outliers

For finding outliers we used couple methods:

-   grubbs test

-   boxplots

-   Interqunatile Range Method - Q-Q plot

Since we defined outliers for every feature, we paid special attention to price since this is the subject of our research.

```{r}
categorical_var <- c("city", "type", "ownership", "buildingMaterial", "condition", "hasParkingSpace", "hasBalcony", "hasElevator", "hasSecurity", "hasStorageRoom", "id", "month")

# Outliers
grubbs_test_buy <- 
  sapply(data_buy[,!names(data_buy) %in% categorical_var], grubbs.test)
print("variables with p.value lower than 5% - buy")
grubbs_test_buy["p.value",][grubbs_test_buy["p.value",] < 0.05]

  

grubbs_test_rent <- 
 sapply(data_buy[,!names(data_rent) %in% categorical_var], grubbs.test)
print("variables with p.value lower than 5% - rent")
grubbs_test_buy["p.value",][grubbs_test_buy["p.value",] < 0.05]
```

Grubbs test allows us defining features with potential outliers.

<h4 style="text-align: center;font-weight: bold;">

Outliers visualization for the 'buy' data set

<h4>

```{r warning=FALSE}
# boxplots buy
bp1 <- ggplot(pivot_longer(data_buy[c("schoolDistance", "postOfficeDistance","kindergartenDistance", "restaurantDistance", "pharmacyDistance")], cols=c("schoolDistance", "postOfficeDistance","kindergartenDistance", "restaurantDistance", "pharmacyDistance")), aes(name, value)) + 
  geom_boxplot() +
  ggtitle("Public destination distance outliers") + 
  labs(x="", y="Miles") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
  theme(text = element_text(size = 25)) 

bp2 <- ggplot(pivot_longer(data_buy[c("floor", "floorCount")], cols=c("floor", "floorCount")), aes(name, value)) + 
  geom_boxplot() +
  ggtitle("Floor and floor count outliers") + 
  labs(x="", y="Count") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

bp3 <- ggplot(pivot_longer(data_buy[c("poiCount")], cols="poiCount"), aes(name, value)) + 
  geom_boxplot() +
  ggtitle("PoI count outliers") + 
  labs(x="", y="Count") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

bp4 <- ggplot(pivot_longer(data_buy[c("price")], cols="price"), aes(name, value)) + 
  geom_boxplot() +
  ggtitle("Price outliers") + 
  labs(x="", y="PLN") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

ggarrange(bp1, bp2, bp3, bp4, ncol = 2, nrow = 2)
```

<h4 style="text-align: center;font-weight: bold;">

Outliers visualization for the 'rent' data set

<h4>

```{r warning=FALSE}
# boxplots rent
bp1 <- ggplot(pivot_longer(data_rent[c("schoolDistance", "postOfficeDistance","kindergartenDistance", "restaurantDistance", "pharmacyDistance")], cols=c("schoolDistance", "postOfficeDistance","kindergartenDistance", "restaurantDistance", "pharmacyDistance")), aes(name, value)) + 
  geom_boxplot() +
  ggtitle("Public destination distance outliers") + 
  labs(x="", y="Miles") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
  theme(text = element_text(size = 25)) 

bp2 <- ggplot(pivot_longer(data_rent[c("floor", "floorCount")], cols=c("floor", "floorCount")), aes(name, value)) + 
  geom_boxplot() +
  ggtitle("Floor and floor count outliers") + 
  labs(x="", y="Count") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

bp3 <- ggplot(pivot_longer(data_rent[c("poiCount")], cols="poiCount"), aes(name, value)) + 
  geom_boxplot() +
  ggtitle("PoI count outliers") + 
  labs(x="", y="Count") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

bp4 <- ggplot(pivot_longer(data_rent[c("price")], cols="price"), aes(name, value)) + 
  geom_boxplot() +
  ggtitle("Price outliers") + 
  labs(x="", y="PLN") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

ggarrange(bp1, bp2, bp3, bp4, ncol = 2, nrow = 2)
```

The boxplots exhibit a dense concentration of outliers, with no observations noticeably separated from the rest. This suggests that the detected outliers are not due to erroneous data but rather a result of a fat-tailed distribution in the given features.

```{r}
# Interqunatile Range Method for price outliers
buy_Q1 <- quantile(data_buy$price, 0.25, na.rm = TRUE)
buy_Q3 <- quantile(data_buy$price, 0.75, na.rm = TRUE)
buy_IQR_value <- buy_Q3 - buy_Q1
buy_lower_bound <- max(0, buy_Q1 - 1.5 * buy_IQR_value)  # Adjust lower bound to 0, because price cannot be negative
buy_upper_bound <- buy_Q3 + 1.5 * buy_IQR_value

rent_Q1 <- quantile(data_rent$price, 0.25, na.rm = TRUE)
rent_Q3 <- quantile(data_rent$price, 0.75, na.rm = TRUE)
rent_IQR_value <- rent_Q3 - rent_Q1
rent_lower_bound <- max(0, rent_Q1 - 1.5 * rent_IQR_value)  # Adjust lower bound to 0, because price cannot be negative
rent_upper_bound <- rent_Q3 + 1.5 * rent_IQR_value

# Identify price outliers 
buy_outliers <- 
  data_buy[data_buy$price < buy_lower_bound | data_buy$price > buy_upper_bound,]
rent_outliers <- 
  data_rent[data_rent$price < rent_lower_bound | data_rent$price > rent_upper_bound,]

# See how many values are outliers related to the original dataset
print("price outliers related to the original dataset in % - buy")
round((length(buy_outliers$price)/length(data_buy$price)) * 100,1)
print("price outliers related to the original dataset in % - rent")
round((length(rent_outliers$price)/length(data_rent$price)) * 100,1) 
```

#### Taking a closer look at the rent outliers

```{r}
# Taking a closer look at the rent outliers
knitr::kable(data_rent[data_rent$price == min(data_rent$price), ][c("city", "price", "squareMeters", "poiCount")])
knitr::kable(data_rent[data_rent$price == max(data_rent$price), ][c("city", "price", "squareMeters", "poiCount")])

```

While 346 PLN for rent may seem low, there are multiple observations close to this price. There are 3 observations with price of 23 000 PLN, all located in the center of Warsaw, where there is a high density of points of interest (POI).

```{r}
# Taking a closer look at the buy outlier
knitr::kable(data_buy[data_buy$price == min(data_buy$price), ][c("city", "price", "squareMeters", "poiCount")])
knitr::kable(data_buy[data_buy$price == max(data_buy$price), ][c("city", "price", "squareMeters", "poiCount")])
```

For apartments listed for sale, neither a price of 1,500,000 PLN nor 3,250,000 PLN appears alarming or unusual. There are multiple listings with prices close to these values, suggesting they are within a reasonable range.

An additional confirmation of the price distribution would be a Q-Q plot. Since apartment prices are typically log-normally distributed, a Q-Q plot of log-transformed rent prices would help assess their conformity to this distribution.

```{r}
qqnorm(log(data_buy$price), main = "Normal Q-Q Plot ('buy' data set)", cex.lab=3, cex.main=3, cex.axis=3)
qqline(log(data_buy$price))
qqnorm(log(data_rent$price), main = "Normal Q-Q Plot ('rent' data set)", cex.lab=3, cex.main=3, cex.axis=3)
qqline(log(data_rent$price))

```

In our case distributions are fat-tailed.

#### Data validation

Data validation ensures data correctness by verifying logical consistency and identifying anomalies. In this data set, we checked the following properties:

-   Floor number is less than or equal to the total floor count.

-   Build year is less than 2524.

-   Latitude and longitude fall within Poland's geographic range.

```{r}
# Data validation
RULE <- editfile("RULES")
violated_buy <- violatedEdits(RULE, data_buy)
# summary(violated_buy)

RULE <- editfile("RULES")
violated_rent <- violatedEdits(RULE, data_rent)
# summary(violated_rent)
```

#### Data imputation

Since there are no incorrect data or outliers, we can proceed with imputing missing values using the MICE method, specifically the classification and regression trees (CART) variation. First, we encode text and categorical variables to make them suitable for imputation. Next, we perform the imputation, verify its success, and finally decode the variables back to their original format.

To avoid retraining the model each time, we will save the imputation results and disable the relevant cells from running in every Markdown execution.

```{r eval=FALSE}
# coding data - buy dataset
data_buy$condition <- 
  data_buy$condition %>% 
  ordered(c("low", "premium")) %>% 
  as.numeric()-1 

data_buy$buildingMaterial <- 
  data_buy$buildingMaterial %>% 
  ordered(c("brick", "concreteSlab")) %>% 
  as.numeric()-1 

data_buy$type <- 
  data_buy$type %>% 
  ordered(c("apartmentBuilding", "blockOfFlats", "tenement")) %>% 
  as.numeric()-1 

data_buy$hasElevator <- 
  data_buy$hasElevator %>% 
  ordered(c("no", "yes")) %>% 
  as.numeric()-1 
```

```{r eval=FALSE}
# MICE imputation
imp_buy <- mice(data_buy, m=3, maxit=3, method="cart")

# Pool results into final dataset
complete_data_buy <- complete(imp_buy)
```

```{r eval=FALSE}
# evaluating imputation results
data.frame(miss_var_summary(complete_data_buy))
```

Data was successfully imputed

```{r eval=FALSE}
# decoding variables
complete_data_buy$condition <- ifelse(complete_data_buy$condition == 0, "low", "premium")
complete_data_buy$buildingMaterial <- ifelse(complete_data_buy$buildingMaterial == 0, "brick", "concreteSlab")
complete_data_buy$type <- ifelse(complete_data_buy$type == 0, "apartmentBuilding",
                        ifelse(complete_data_buy$type == 1, "blockOfFlats", "tenement"))
complete_data_buy$hasElevator <- ifelse(complete_data_buy$hasElevator == 0, "no", "yes")
```

```{r eval=FALSE}
# saving imputed data
write.csv(complete_data_buy,"clean_buy.csv")
```

```{r eval=FALSE}
# coding vriables - rent dataset
data_rent$condition <- 
  data_rent$condition %>% 
  ordered(c("low", "premium")) %>% 
  as.numeric()-1 

data_rent$buildingMaterial <- 
  data_rent$buildingMaterial %>% 
  ordered(c("brick", "concreteSlab")) %>% 
  as.numeric()-1 

data_rent$type <- 
  data_rent$type %>% 
  ordered(c("apartmentBuilding", "blockOfFlats", "tenement")) %>% 
  as.numeric()-1 

data_rent$hasElevator <- 
  data_rent$hasElevator %>% 
  ordered(c("no", "yes")) %>% 
  as.numeric()-1
```

```{r eval=FALSE}
# Multiple data imputation
imp_rent <- mice(data_rent, m=3, maxit=3, method="cart")

# Pool results into final dataset
complete_data_rent <- complete(imp_rent)
```

```{r eval=FALSE}
# evaluating imputation
data.frame(miss_var_summary(complete_data_rent))
```

```{r eval=FALSE}
# decoding variables
complete_data_rent$condition <- ifelse(complete_data_rent$condition == 0, "low", "premium")
complete_data_rent$buildingMaterial <- ifelse(complete_data_rent$buildingMaterial == 0, "brick", "concreteSlab")
complete_data_rent$type <- ifelse(complete_data_rent$type == 0, "apartmentBuilding",
                        ifelse(complete_data_rent$type == 1, "blockOfFlats", "tenement"))
complete_data_rent$hasElevator <- ifelse(complete_data_rent$hasElevator == 0, "no", "yes")
```

```{r eval=FALSE}
# saving imputed data
write.csv(complete_data_rent,"clean_rent.csv")
```

## Visualizations

```{r upload the data, include=FALSE}
complete_data_buy <- read.csv("clean_buy.csv")
complete_data_buy <- complete_data_buy %>%
  select(-X)
complete_data_rent <- read.csv("clean_rent.csv")
complete_data_rent <- complete_data_rent %>%
  select(-X)
# or
# complete_data_buy <- complete_data_buy
# complete_data_rent <- complete_data_rent
```

```{r, fig.width=10, fig.height=8}
total_median_buy <- median(complete_data_buy$price)

plot_median_buy <- complete_data_buy %>%
  group_by(city) %>%
  summarise(median_price = median(price)) %>%
  ggplot(aes(x = reorder(city, median_price), 
             y = median_price,
             fill = median_price > total_median_buy)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("FALSE" = "#90EE90", "TRUE" = "#ffadad"), guide = "none") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Median Purchase Price by City", 
       x = "City", 
       y = "Median Price") +
  scale_y_continuous(labels = label_comma()) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 


total_median_rent <- median(complete_data_rent$price)

plot_median_rent <- complete_data_rent %>%
  group_by(city) %>%
  summarise(median_price = median(price)) %>%
  ggplot(aes(x = reorder(city, median_price), 
             y = median_price,
             fill = median_price > total_median_rent)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("FALSE" = "#90EE90", "TRUE" = "#ffadad"), guide = "none") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Median Rent Price by City", 
       x = "City", 
       y = "Median Price") +
  scale_y_continuous(labels = label_comma()) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

grid.arrange(plot_median_buy, plot_median_rent, ncol = 2)
```

There are highest prices for housing purchasing in the largest polish cities as it follows from the graph. The highest prices are in Warsaw, Krakow and Gdansk, while the cheapest housings are in Czestochowa, Radom and Bydgoszcz. The rent prices are a little more close in terms of the median values, nevertheless there is an outlier - capital city Warsaw, where the median is over 30% higher than in other cities.

### The impact of amenities on price

```{r message=FALSE, warning=FALSE}
ggplot(complete_data_buy, aes(x = squareMeters, y = price)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", color = "red") +
  facet_wrap(~city) +
  labs(title = "Appartemnt Price vs Size by City") +
  scale_y_continuous(labels = label_comma()) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 
```

There is a clearly visible positive correlation between the size of an apartment and its price. The slope of the read line (smoothing) is the greatest for the cities with the most expensive apartments, so the result is correlated with conclusions made earlier.

```{r, fig.width=10, fig.height=8}
complete_data_buy %>%
  gather(amenity, has_amenity, c(hasBalcony, hasElevator, hasParkingSpace, hasStorageRoom, hasSecurity, )) %>%
  ggplot(aes(x = has_amenity, y = price)) +
  geom_boxplot(fill = "lightblue") +
  facet_wrap(~amenity) +
  labs(title = "Price Distribution by Amenities") +
  scale_y_continuous(labels = label_comma()) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 
```

The trend is as expected: the presence of amenities increases the price of housing, while there is an outlier amenity - storage room. The median price for housings with a storage room is lower than without it. The difference in price for the categories is plotted on the next graph.

```{r}
complete_data_buy %>%
  gather(amenity, has_amenity, c(hasBalcony, hasElevator, hasParkingSpace, hasStorageRoom, hasSecurity)) %>%
  group_by(amenity) %>%
  mutate(
    avg_no = mean(price[has_amenity == "no"]),
    avg_yes = mean(price[has_amenity == "yes"]),
    pct_diff = (avg_yes - avg_no) / avg_no * 100
  ) %>%
  ggplot(aes(x = reorder(amenity, pct_diff), y = pct_diff, fill = pct_diff > 0)) +
  geom_col() +
  scale_fill_manual(values = c("FALSE" = "#ffadad", "TRUE" = "#90EE90"), guide = "none") +
  coord_flip() +
  labs(
    title = "Price Premium for Amenities",
    x = "Amenity",
    y = "Price Difference (%)",
    fill = "Price Impact"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = function(x) paste0(round(x, 1), "%")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

```

Amenities (all but storageRoom) seem to have a noticeable positive impact on price of the apartment.

### Correlation exploration

<h4 style="text-align: center;font-weight: bold;">

Purchase data set

<h4>

```{r}
distance_vars_buy <- select(complete_data_buy, contains("Distance"), price)
correlation_matrix_buy <- cor(distance_vars_buy, use = "complete.obs")
corrplot(correlation_matrix_buy, method = "color", addCoef.col = 1,
         tl.cex = 1.8, number.cex = 1.8)
```

There is no strong correlation found between the level of prices and distance to public places. However there is pretty solid positive correlation between variables of distances to public places.

<h4 style="text-align: center;font-weight: bold;">

Rental data set

<h4>

```{r}
distance_vars_rent <- select(complete_data_rent, contains("Distance"), price)
correlation_matrix_rent <- cor(distance_vars_rent, use = "complete.obs")
corrplot(correlation_matrix_rent, method = "color", addCoef.col = 1,
         tl.cex = 1.8, number.cex = 1.8)
```

Similar trends are observed on a rent market data set.

```{r message=FALSE, warning=FALSE, fig.width=10, fig.height=6}
plot_age_buy <- ggplot(complete_data_buy, aes(x = buildYear, y = price)) +
  geom_smooth() +
  labs(title = "Price vs Building Age – Purchase") +
  scale_y_continuous(labels = label_comma()) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

plot_age_rent <- ggplot(complete_data_rent, aes(x = buildYear, y = price)) +
  geom_smooth() +
  labs(title = "Price vs Building Age – Rent") +
  scale_y_continuous(labels = label_comma()) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 
grid.arrange(plot_age_buy, plot_age_rent, ncol = 2)
```

Interesting things can be observed – model is less certain about the smooth price for apartments for rent built in the 70s, which might suggest there's less of them available for rent. This phenomena is correlated with modern market rules, as the demand on the new apartments is higher. The apartments in very old buildings tend to be very expensive, but there are not many of them. Commie blocks are the least expensive for both rent and purchase. Out of modern buildings those built around 2508 seem to be the most expensive. The prices for the newest buildings seem to be falling with each year.

```{r, fig.width=10, fig.height=6}
ggplot(complete_data_buy, aes(x = condition, y = price)) +
  geom_violin(fill = "beige") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Price Distribution by Property Condition") +
  scale_y_continuous(labels = label_comma()) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 
```

There is no significant influence of housing condition on the price level.

## Descriptive analysis

### Summary statistics

```{r}
data_buy <- complete_data_buy
data_rent <- complete_data_rent

data_buy <- data_buy %>% 
  mutate(price_per_m2 = price / squareMeters)
data_rent <- data_rent %>% 
  mutate(price_per_m2 = price / squareMeters)

print(dfSummary(data_buy, na.col=FALSE, headings=FALSE, valid.col=FALSE),
      method = "render")
```

Summary table contains information about every column in the purchase data set. It can be noticed from the table that

1)  Every city occupies different part of the country market;
2)  The most common building type is block of flats, while apartment buildings and tenements occupy \~25% of the market each;
3)  Average housing area (m²) is 58.7, while this variable has right-skewed distribution;
4)  The most widespread are 2 and 3 room apartments, whereas other categories make up under 25% of the total;
5)  The histogram of floor values is falling, which is expected behavior;
6)  There are apartments in buildings build from 1850 to 2524. Average trend is growing, but there are some drops in certain periods;
7)  Distance variables and POI count seem to have right skewed distribution, as public facilities are erected in the most populated areas;
8)  Almost 90% of apartments are owned on condominium agreement.

```{r}
print(dfSummary(data_rent, na.col=FALSE, headings=FALSE, valid.col=FALSE),
      method = "render")
```

Rental market data in general follow the same trend, however there are some differences:

1)  Apartment buildings are the most common type of building the housing is located in;
2)  Area of the apartments is a bit lower (average 53.4 m²) than in case of purchase market;
3)  Two room apartments are the most represented category with over 57% of items;
4)  The average of build year is higher for rental market (by 12 years), which is explained by higher attractiveness of modern buildings for tenants;
5)  97.7% of the apartments is declared to be in premium condition.

### Share of market by city with contingency tables

```{r contingency_table1}
table <- table(data_buy$city) %>% 
  as.data.frame() 

table$Share <- round(prop.table(table$Freq), 4)*100 

arrange(table, desc(Share)) %>% 
  kable(col.names=c("City", "Quantity", "Share, %")) %>% 
  kable_styling()

```

It follows from the data that the largest share of the apartments market is in Warsaw (above 30% of the country market), smaller parts of the market represent next major cities: Kraków (15.26%), Wrocaław (10.32%) and Gdańsk (8.87%).

```{r contingency_table1.1}
table <- table(data_rent$city) %>% 
  as.data.frame() 

table$Share <- round(prop.table(table$Freq), 4)*100 

arrange(table, desc(Share)) %>% 
  kable(col.names=c("City", "Quantity", "Share, %")) %>% 
  kable_styling()

```

Warsaw has even larger part of the rent market almost 40%, growth also noticeable in the market share of Krakow (+4%). Remaining cities have minor shares of this market (under 10% each).

### Price distribution shape with tabular data

```{r contingency_table2, fig.width=10, fig.height=6}
# range(data_buy$price)

limits <- seq(min(data_buy$price)-500000, max(data_buy$price)+500000, by=100000)

limits_factor <- cut(data_buy$price, limits)
table_price <- table(limits_factor, dnn = c("Limits"))
# transform(table_price, Percentage=prop.table(Freq)) #, Cum_Freq=cumsum(Freq))

hist(data_buy$price, prob=TRUE, breaks=limits, main="Price groupping for purchase market", xlab="Price in PLN", col="lightblue", cex.lab=3, cex.main=3, cex.axis=3)
lines(density(data_buy$price), col=2)

print("TAI (tabular accuracy index)")
tab_accuracy <- classIntervals(data_buy$price, n=10, style="fixed", fixedBreaks=limits)
#tabular accuracy index
jenks.tests(tab_accuracy)

pcol= c('darkblue', 'blue', 'lightblue', 'palegreen', 'lightpink', 'brown3', 'red', 'yellow', 'brown', 'black')
colcode=findColours(tab_accuracy, pcol)
plot(tab_accuracy, pal=pcol, ylab='Cumulative %', cex.lab=3, cex.main=3, cex.axis=3)

```

The price has skewed distribution distribution. A histogram was build to show how many housings fall in certain price levels from minimum price 150000 up to the maximum 3250000 by 100000 PLN. The histogram shows that most represented category is 600-700 thousands PLN. The partition accuracy was checked with the tabular accuracy index, which shows high tabular accuracy and goodness of fit.

```{r contingency_table2.2, fig.width=10, fig.height=6}
# range(data_rent$price)
limits <- seq(min(data_rent$price) - 300, max(data_rent$price) + 300, by=500)

limits_factor <- cut(data_rent$price, limits)
table_price <- table(limits_factor, dnn = c("Limits"))
# transform(table_price, Percentage=prop.table(Freq)) #, Cum_Freq=cumsum(Freq))

hist(data_rent$price, prob=TRUE, breaks=limits, main="Price groupping for rental market", xlab="Price in PLN", col="lightblue", cex.lab=3, cex.main=3, cex.axis=3)
lines(density(data_rent$price), col=2)

print("TAI (tabular accuracy index)")
tab_accuracy <- classIntervals(data_rent$price, n=10, style="fixed", fixedBreaks=limits)
#tabular accuracy index
jenks.tests(tab_accuracy)

pcol= c('darkblue', 'blue', 'lightblue', 'palegreen', 'lightpink', 'brown3', 'red', 'yellow', 'brown', 'black')
colcode=findColours(tab_accuracy, pcol)
plot(tab_accuracy, pal=pcol, ylab='Cumulative %', cex.lab=3, cex.main=3, cex.axis=3)

```

The shapes of the rental market distribution is narrower than purchase market one, which can be explained by the target groups of these offers (often these group cannot afford to buy a housing).

```{r warning=FALSE, fig.width=10, fig.height=6}
pl1 <- data_buy %>%
  ggplot(aes(x=price_per_m2)) +
  geom_density(color="#69b3a2", alpha=0.8, size=1.5) +
  geom_vline(aes(xintercept=median(price_per_m2)), linetype="dashed", size=0.8, color="69b3a2") +
  annotate("text", x=12500, y=0.00004, label=paste("Median: ", as.character(median(round(data_buy$price_per_m2, 2)))), angle=90, color="69b3a2", fontsize=15) +
  ggtitle("Purchase market") + 
  labs(x="PLN per square meter", y="Density") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

pl2 <- data_rent %>%
  ggplot(aes(x=price_per_m2)) +
  geom_density(color="#69b3a2", alpha=0.8, size=1.5) +
  geom_vline(aes(xintercept=median(price_per_m2)), linetype="dashed", size=0.8, color="69b3a2") +
  annotate("text", x=60, y=0.01, label=paste("Median: ", as.character(median(round(data_rent$price_per_m2, 2)))), angle=90, color="69b3a2", fontsize=15) +
  ggtitle("Rental market") + 
  labs(x="PLN per square meter", y="Density") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 


grid.arrange(pl1+theme(legend.position="top"),
    pl2+theme(legend.position="top"),
    ncol = 2,
    top =textGrob("Price per square meter",gp=gpar(fontsize=35)))
```

This image shows density plots for the price per square meter in both the purchase and rental markets. The distribution graphs of prices per square meter are less skewed than normal prices and additionally:

1.  Purchase Market

    -   The distribution appears right-skewed (positively skewed), meaning more properties have prices below the median, with some high-priced outliers.

    -   The median price per square meter is **13,322.98 PLN**.

    -   There's a peak around **10,000-15,000 PLN**, suggesting a common price range.

2.  Rental Market

    -   Also right-skewed, but with a sharper peak and a steeper decline.

    -   The median rental price per square meter is **65.67 PLN**.

    -   Most rentals are concentrated in the **40-80 PLN per square meter range**.

### Housing type percentage in different cities

```{r contingency_table3}
type_across_cities <- table(data_buy$city, data_buy$type, dnn = c("City", "Type"))
addmargins(round(prop.table(type_across_cities, 1) * 100, 2), 2) %>% 
  kable() %>% 
  kable_styling()
```

The table shows percentage of housing of the certain type per city. There are cities with higher percentage of apartment buildings (Gdansk, Gdynia, Krakow, Warszawa and Wroclaw), which are characterized by greater market share and higher prices, while in smaller cities with lower prices relative quantity of offers in blocks of flats is higher (Bialystok, Czestohchowa, Lublina, Radom). Nonetheless there is a common trend for each of the cities: the majority of housings is offered in blocks of flats, while apartments of buildings and tenements make up a smaller group of housings.

```{r contingency_table4}
type_across_cities <- table(data_rent$city, data_rent$type, dnn = c("City", "Type"))
addmargins(round(prop.table(type_across_cities, 1) * 100, 2), 2) %>% 
  kable() %>% 
  kable_styling()
```

The situation is somewhat different for the rental market. There is an increase in apartment buildings type offers resulting in an incline in percentage of block of flats. Quantity of offers in tenements is also reduced insignificantly.

#### Descriptive characteristics of price per m² in purchase data set

```{r echo=FALSE}
group_by(data_buy, type) %>%
  reframe(
    mean = mean(price_per_m2),
    sd = sd(price_per_m2),
    median = median(price_per_m2),
    min = min(price_per_m2),
    max = max(price_per_m2),
    skewness = skew(price_per_m2),
    kurtosis = kurtosis(price_per_m2)
  ) %>% 
  kable() %>% 
  kable_styling()

```

The **most expensive** in terms of price per square meter are housings in **apartment buildings**. Their average price is **26.8%** more for blocks of flats and **25.1%** for tenements in purchasing. The smallest **standard deviation** value for blocks of flats in both markets can be explained by average characteristics of this type of housing: locations and conditions are close in different blocks of flats or apartments, while there are old, cheaper tenements and relatively small amount of the new ones in perfect condition and location so the deviation is significantly larger. Positive values of **skewness** indicate the tail of the distribution is on the right, which means the amount of more expensive apartments is fading more gradually than the cheaper ones. **Kurtosis** indicates quite peaked distributions for each category.

#### Descriptive characteristics of price per m² in rental data set

```{r echo=FALSE, warning=FALSE}
group_by(data_rent, type) %>%
  reframe(
    mean = mean(price_per_m2),
    sd = sd(price_per_m2),
    median = median(price_per_m2),
    min = min(price_per_m2),
    max = max(price_per_m2),
    skewness = skew(price_per_m2),
    kurtosis = kurtosis(price_per_m2)
    # range = range(price)
  ) %>% 
  kable() %>% 
  kable_styling()
```

Apartments in apartment buildings have the highest average rent (75.77 PLN/m²) and median (72.38 PLN/m²), suggesting they tend to be more expensive. Block of flats has the lowest average (61.56 PLN/m²) and median (59.26 PLN/m²), meaning they are generally more affordable, while tenements are in between as it was for purchasing data set. Standard deviation is highest for tenements (24.05 PLN/m²) and apartment buildings (23.23 PLN/m²), indicating a wider spread in rental prices. The maximum rental price is quite high for all categories (\~189 PLN/m²), suggesting some luxury or premium properties significantly impact the upper range. Apartment buildings (5.14) and block of flats (5.42) have higher kurtosis, indicating a sharper peak with more extreme values. Tenements (3.90) have a more moderate kurtosis, meaning a more balanced distribution without extreme outliers.

```{r statistical_variables, fig.width=10, fig.height=6}

mu_buy <- ddply(data_buy, "type", summarise, grp.mean=mean(price_per_m2))

pl1 <- ggplot(data_buy, aes(x=price_per_m2, color=type)) +
  geom_density(size=1.5) +
  theme(legend.position="top") +
  geom_vline(data=mu_buy, aes(xintercept=grp.mean, color=type), linetype="dashed") +    
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9")) +
  theme_classic() +
  labs(x="PLN per square meter", y="Density", subtitle  = "Purchase market") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

mu_rent <- ddply(data_rent, "type", summarise, grp.mean=mean(price_per_m2))

pl2 <- ggplot(data_rent, aes(x=price_per_m2, color=type)) +
  geom_density(size=1.5) +
  geom_vline(data=mu_rent, aes(xintercept=grp.mean, color=type), linetype="dashed") +   
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9")) + 
  theme_classic() +
  labs(x="PLN per square meter", y="Density", subtitle  = "Rental market") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text = element_text(size = 25)) 

grid.arrange(pl1+theme(legend.position="top"),
    pl2+theme(legend.position="top"),
    ncol = 2,
    top =textGrob("Distribution of price per square meter by housing type",gp=gpar(fontsize=35))
)
```

This image presents density plots for the distribution of price per square meter in both the purchase and rental markets, categorized by housing type (apartment buildings, blocks of flats and tenements). Purchase prices are more spread out than rental prices, particularly for apartment buildings. Rental prices are relatively more concentrated, with fewer extreme values. Blocks of flats consistently show the lowest prices and least variation, making them the most affordable option. Apartment buildings are the most expensive, both in purchase and rental markets, with more high-priced outliers.

### Housing type vs building material with mosaic plots

<h4 style="text-align: center;font-weight: bold;">

Purchase market

<h4>

```{r, fig.width=10, fig.height=6}
mosaicplot(table(data_buy$type, data_buy$buildingMaterial), color = c("darkred", "grey"), main="", cex.axis=2)
```

<h4 style="text-align: center;font-weight: bold;">

Rental market

<h4>

```{r, fig.width=10, fig.height=6}
mosaicplot(table(data_rent$type, data_rent$buildingMaterial), color = c("darkred", "grey"), main="", cex.axis=2)
```

The majority of housings is build of brick, while this material is used more frequently in apartment buildings and tenements than in blocks of flats, which are made of concrete slab in one third of cases. The trend is common for purchasing and rental markets.

## Statistical tests

Statistical tests are conducted to determine whether observed data patterns are due to chance or represent real effects. They help in making objective decisions, validating hypotheses, and drawing conclusions in research by measuring relationships, differences, or associations within data sets.

### Statistical significance of price median difference between cities

The main purpose of the statistical test we are going to perform is to determine which variables have a statistically significant impact on both rent and buy prices.

```{r}
palette_colors <- viridis(length(unique(complete_data_buy$city)))

complete_data_buy %>% 
  ggbetweenstats(
    y = price,
    x = city,
    bf.message = FALSE,
    pairwise.display = "none",
    title = "Distribution of buy price across cities - buy dataset",
    palette = "default_ucscgb",
    package = "ggsci",
    centrality.label.args = list(size  = 7)
  ) +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme(plot.title = element_text(hjust = 0.5, size = 35), text = element_text(size = 25)) 

complete_data_rent %>% 
  ggbetweenstats(
    y=price,
    x=city,
    bf.message = FALSE,
    pairwise.display = "none",
    title = "Distribution of rent price across cities - rent dataset",
    palette = "default_ucscgb",
    package = "ggsci",
    centrality.label.args = list(size  = 7)
  ) +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme(plot.title = element_text(hjust = 0.5, size = 35), text = element_text(size = 25)) 

```

Based on Welch's test, we obtained a p-value close to 0, so we reject the null hypothesis of equal means between populations in both the buy and rent data sets. This means that the city statistically significantly differentiates both rent and buy prices. However, an effect size of 0.86 implies that this differentiation has a moderate magnitude.

### Statistical significance differentiation of price by amenities

```{r}
amentities <- c("hasBalcony", "hasElevator", "hasParkingSpace", "hasStorageRoom", "hasSecurity")
for (i in amentities) {
  print(
    complete_data_buy %>%
      ggbetweenstats(
        y = price,
        x = !!sym(i),
        bf.message = FALSE,
        palette = "default_ucscgb",
        package = "ggsci",
        title = paste("Buy Price Distribution by", i),
        centrality.label.args = list(size  = 10)
      ) +
      theme(plot.title = element_text(hjust = 0.5, size = 35), text = element_text(size = 25)) 
  )
}
```

All amenities appear to statistically significantly differentiate buy price, but their effect sizes are small, ranging from -0.14 for a balcony to -0.57 for an elevator.

```{r}
for (i in amentities) {
  print(
    complete_data_rent %>%
      ggbetweenstats(
        y = price,
        x = !!sym(i),
        bf.message = FALSE,
        palette = "default_ucscgb",
        package = "ggsci",
        title = paste("Rent Price Distribution by", i),
        centrality.label.args = list(size  = 10)
      ) +
      theme(plot.title = element_text(hjust = 0.5, size = 35), text = element_text(size = 25)) 
  )
}
```

Similarly to buy prices, all amenities appear to statistically significantly differentiate buy price, but their effect sizes are small, ranging from -0.10 for a balcony to -0.31 for an elevator.

```{r}
complete_data_buy %>%
  ggbetweenstats(
    y = price,
    x = condition,
    bf.message = FALSE,
    palette = "default_ucscgb",
    package = "ggsci",
    title = "Buy price difference by condition",
    centrality.label.args = list(size  = 10)
  ) +
  theme(plot.title = element_text(hjust = 0.5, size = 35), text = element_text(size = 25))  

complete_data_rent %>%
  ggbetweenstats(
    y = price,
    x = condition,
    bf.message = FALSE,
    palette = "default_ucscgb",
    package = "ggsci",
    title = "Rent price difference by condition",
    centrality.label.args = list(size  = 10)
  ) +
  theme(plot.title = element_text(hjust = 0.5, size = 35), text = element_text(size = 25)) 
```

Finally, condition of flat in both rent and buy data sets also seem to differentiate price significantly but has only moderate magnitude.

## Conclusions

This project provides a comprehensive analysis of the real estate market, utilizing statistical methods and visualizations to uncover key trends and insights. The study examines data structure, performs data cleansing, and addresses outliers to ensure accuracy. Through descriptive analysis and summary statistics, the project identifies variations in market share across cities and explores price distribution patterns.

The following problems were explored among others:

-   A data-driven overview of real estate pricing trends.

-   Identification of key factors influencing property prices.

-   Insights into how housing types and amenities impact pricing.

-   Statistical validation of differences in pricing across various cities.

### Findings and insights

Certain cities (e.g., Gdańsk, Gdynia, Częstochowa) show significant missing data in condition and build year attributes, however there is no strong correlation between missing values and other features. The highest property prices are in Warsaw, Krakow, and Gdansk, while the cheapest cities are Czestochowa, Radom, and Bydgoszcz. Property prices follow a fat-tailed distribution, while high-priced properties are concentrated in city centers with dense POIs. No strong correlation is found between price levels and proximity to public places, but distances between amenities show a strong relationship.

Rental and purchase price distributions by cities, amenities and condition differ significantly, as confirmed by Welch’s test (p-value ≈ 0). Rental prices are more uniform, except in Warsaw, where the median rent is 30% higher than in other cities. A positive correlation exists between apartment size and price, with larger price increases in cities with higher property costs. Amenities generally increase housing prices, except for storage rooms, which correlate with lower prices, but the effect size is small (e.g., -0.14 for balconies, -0.57 for elevators). Housing condition has a moderate impact on prices, but its effect size is limited.

The study confirms that city location, property size, and amenities significantly influence real estate prices. While rental prices show more uniformity, purchase prices exhibit stronger variations based on property type and city. Warsaw dominates both markets, with modern buildings losing value over time. Statistical tests validate these findings, providing insights for investors, buyers, and policymakers.
